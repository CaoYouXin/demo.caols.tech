<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

    <title>O2O</title>

    <link rel="stylesheet" type="text/css" href="../css/clear.css">

    <style>
        body {
            font-size: 0;
            background-color: #eeeeee;

            overflow: hidden;
        }

        .phone {
            width: 376px;
            height: 738px;

            margin: 0 auto;

            background: url("../image/iphone.png") no-repeat;

            transform-origin: 50% 0 0;
            transition: all .3s ease-in-out;
        }

        .iframe {
            margin: 0;

            position: relative;

            width: 320px;
            max-width: 320px;
            height: 480px;

            left: 30px;
            top: 130px;
        }

        iframe {
            width: 320px;
            max-width: 320px;
        }
    </style>

    <script src="../js/jq/jquery.min.js"></script>
    <script src="../js/jq/jquery.easing.1.3.js"></script>
    <script src="../js/jq/jquery.nicescroll.min.js"></script>
    <script src="../js/jq/jquery.nicescroll.plus.js"></script>
    <script>

        window.MutationObserver = window.MutationObserver
            || window.WebKitMutationObserver
            || window.MozMutationObserver;

        $(document).ready(function () {
            document.querySelector('.phone').style.transform = 'scale(' + (window.innerHeight / 738) + ')';

            $(".iframe").niceScroll(".iframe iframe", {cursorcolor: "#0F0"});
            var cw = null;
            var target = document.querySelector('iframe'),
                observer = new MutationObserver(function (mutation) {

                    if (!mutation.length) {
                        return;
                    }
                    console.log('mutation', cw === target.contentWindow, mutation);

                    mutation.forEach(function (m) {
                        if (m.attributeName === 'src') {

                            var interval = setInterval(function () {
                                try {
                                    console.log('to set', target.contentDocument.body);
                                } catch (e) {
                                    clearInterval(interval);
                                }

                                if (target.contentDocument.lastElementChild.offsetWidth) {
                                    clearInterval(interval);

//                            $('.iframe').getNiceScroll().resize();
                                    document.querySelector('iframe').style.height = Math.max(target.contentDocument.body.offsetHeight * target.contentWindow.mobileUtil.bodyScale, 480) + 'px';

                                    target.contentDocument.body.style.cursor = 'url(hyper.cur), pointer';
                                    document.body.style.background = target.contentDocument.body.style.background;

                                    var nodeList = target.contentDocument.querySelectorAll('.store-item-cover');
                                    console.log('setting ', nodeList);
                                    for (var i = 0; i < nodeList.length; i++) {
                                        nodeList.item(i).style.height = (480 / target.contentWindow.mobileUtil.bodyScale) + 'px';
                                        console.log(nodeList.item(i).style.height);
                                    }
                                    console.log('set done');
                                }
                            }, 500);
                        } else if (m.attributeName === 'style') {

                            target.contentDocument.querySelector('footer').style.top = ((480 + Math.abs(parseFloat(target.style.transform.match(/translate3d\(0px, (.*?)px, 0px\)/)[1]))) / target.contentWindow.mobileUtil.bodyScale - 90) + 'px';
                        }
                    });
                }),
                config = {
                    attributes: true
                };

            observer.observe(target, config);

            $("iframe").attr('src', 'store.html');
        });

        function lockScroll() {
            $('.iframe').getNiceScroll().hide();
//            setTimeout(function() {
            var iframe = document.querySelector('iframe');
            var top = parseFloat(iframe.style.transform.match(/translate3d\(0px, (.*?)px, 0px\)/)[1]);

            var nodeList = iframe.contentDocument.querySelectorAll('.store-item-cover');
            for (var i = 0; i < nodeList.length; i++) {
                nodeList.item(i).style.top = (Math.abs(top) / iframe.contentWindow.mobileUtil.bodyScale) + 'px';
            }
//            }, 500);
        }

        function unlockScroll() {
            $('.iframe').getNiceScroll().show();
        }
    </script>
</head>
<body>

<div class="phone">
    <div class="iframe">
        <iframe src="" scrolling="no" frameborder="0"></iframe>
    </div>
</div>

</body>
</html>